<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retail Analytics Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 min-h-screen">
    <nav class="bg-indigo-600 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <h1 class="text-white text-2xl font-semibold">Retail Analytics Dashboard</h1>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- File Upload Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">1. Upload Data File</h2>
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                <form id="uploadForm" class="space-y-4">
                    <div class="flex flex-col items-center">
                        <label class="cursor-pointer bg-indigo-600 text-white px-6 py-2 rounded-md hover:bg-indigo-700 transition-colors">
                            Choose Excel File
                            <input type="file" name="file" class="hidden" accept=".xlsx,.xls">
                        </label>
                        <p class="text-sm text-gray-500 mt-2">Only Excel files (.xlsx, .xls) are accepted</p>
                    </div>
                </form>
                <div id="uploadStatus" class="mt-4 hidden">
                    <div class="flex items-center justify-center text-sm">
                        <span class="text-green-600">File uploaded successfully!</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analysis Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">2. Begin Analysis</h2>
            <button id="analyzeBtn" class="bg-indigo-600 text-white px-6 py-2 rounded-md hover:bg-indigo-700 transition-colors disabled:bg-gray-400" disabled>
                Begin Analysis
            </button>
            <div id="analysisStatus" class="mt-4 hidden">
                <div class="animate-pulse flex space-x-4">
                    <div class="flex-1 space-y-4 py-1">
                        <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="hidden">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">3. Analysis Results</h2>
            <div id="chartsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Charts will be dynamically added here -->
            </div>
        </div>
    </main>

    <script>
        $(document).ready(function() {
            $('input[type="file"]').change(function() {
                const file = this.files[0];
                if (file) {
                    const formData = new FormData();
                    formData.append('file', file);

                    $.ajax({
                        url: '/upload',
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function(response) {
                            $('#uploadStatus').removeClass('hidden');
                            $('#analyzeBtn').prop('disabled', false);
                        },
                        error: function(xhr) {
                            alert('Error uploading file: ' + xhr.responseJSON.error);
                        }
                    });
                }
            });

            $('#analyzeBtn').click(function() {
                $('#analysisStatus').removeClass('hidden');
                $(this).prop('disabled', true);

                $.ajax({
                    url: '/begin_analysis',
                    type: 'GET',
                    success: function(response) {
                        $('#analysisStatus').addClass('hidden');
                        $('#resultsSection').removeClass('hidden');
                        displayResults(response.results);
                    },
                    error: function(xhr) {
                        $('#analysisStatus').addClass('hidden');
                        $('#analyzeBtn').prop('disabled', false);
                        alert('Error during analysis: ' + xhr.responseJSON.error);
                    }
                });
            });
        });

        function displayResults(results) {
            const container = $('#chartsContainer');
            container.empty();

            // High Value Customers
            createChart(container, 'High Value Customers', {
                labels: results.top_customers.map(c => `Customer ${c.customer_id}`),
                datasets: [{
                    label: 'Total Spend',
                    data: results.top_customers.map(c => c.total_spend),
                    backgroundColor: 'rgba(79, 70, 229, 0.6)',
                    borderColor: 'rgba(79, 70, 229, 1)'
                }]
            });

            // Churned Customers
            createChart(container, 'Churned Customers', {
                labels: ['Churned Customers'],
                datasets: [{
                    label: 'Count',
                    data: [results.churned_customers_count],
                    backgroundColor: 'rgba(229, 70, 79, 0.6)',
                    borderColor: 'rgba(229, 70, 79, 1)'
                }]
            });

            // Transactions by Store
            createChart(container, 'Transactions by Store', {
                labels: results.store_performance_summary.map(s => s.store_location),
                datasets: [{
                    label: 'Total Transactions',
                    data: results.store_performance_summary.map(s => s.total_transactions),
                    backgroundColor: 'rgba(79, 70, 229, 0.6)',
                    borderColor: 'rgba(79, 70, 229, 1)'
                }]
            });

            // Store Ratings vs Transaction Value
            createChart(container, 'Store Ratings vs Transaction Value', {
                labels: results.store_performance_summary.map(s => s.store_location),
                datasets: [{
                    label: 'Average Transaction Value',
                    data: results.store_performance_summary.map(s => s.avg_transaction_value),
                    backgroundColor: 'rgba(79, 70, 229, 0.6)',
                    borderColor: 'rgba(79, 70, 229, 1)'
                }, {
                    label: 'Average Rating',
                    data: results.store_performance_summary.map(s => results.average_ratings_by_store[s.store_location] || 0),
                    backgroundColor: 'rgba(229, 70, 79, 0.6)',
                    borderColor: 'rgba(229, 70, 79, 1)'
                }]
            });

            // Average Spend by Age Group
            createChart(container, 'Average Spend by Age Group', {
                labels: Object.keys(results.avg_spend_by_age),
                datasets: [{
                    label: 'Average Spend',
                    data: Object.values(results.avg_spend_by_age),
                    backgroundColor: 'rgba(79, 70, 229, 0.6)',
                    borderColor: 'rgba(79, 70, 229, 1)'
                }]
            });

            // Average Spend by Visit Frequency
            createChart(container, 'Average Spend by Visit Frequency', {
                labels: Object.keys(results.avg_spend_by_frequency),
                datasets: [{
                    label: 'Average Spend',
                    data: Object.values(results.avg_spend_by_frequency),
                    backgroundColor: 'rgba(79, 70, 229, 0.6)',
                    borderColor: 'rgba(79, 70, 229, 1)'
                }]
            });

            // Top 10 Products by Orders
            createChart(container, 'Top 10 Products by Orders', {
                labels: results.top_products.map(p => p.item_name),
                datasets: [{
                    label: 'Total Orders',
                    data: results.top_products.map(p => p.total_orders),
                    backgroundColor: 'rgba(79, 70, 229, 0.6)',
                    borderColor: 'rgba(79, 70, 229, 1)'
                }]
            });

            // Product Revenue vs Rating
            createChart(container, 'Product Revenue vs Rating', {
                labels: results.product_ratings.map(p => p.item_name),
                datasets: [{
                    label: 'Revenue',
                    data: results.product_ratings.map(p => p.total_revenue),
                    backgroundColor: 'rgba(79, 70, 229, 0.6)',
                    borderColor: 'rgba(79, 70, 229, 1)'
                }, {
                    label: 'Rating',
                    data: results.product_ratings.map(p => p.rating_overall),
                    backgroundColor: 'rgba(229, 70, 79, 0.6)',
                    borderColor: 'rgba(229, 70, 79, 1)'
                }]
            });

            // Hourly Transaction Trends
            createChart(container, 'Hourly Transaction Trends', {
                labels: results.hourly_trends.map(h => h.hour),
                datasets: [{
                    label: 'Transaction Count',
                    data: results.hourly_trends.map(h => h.transaction_count),
                    backgroundColor: 'rgba(79, 70, 229, 0.6)',
                    borderColor: 'rgba(79, 70, 229, 1)'
                }]
            });

            // Seasonal Transaction Trends
            createChart(container, 'Seasonal Transaction Trends', {
                labels: results.seasonal_trends.map(s => s.season),
                datasets: [{
                    label: 'Transaction Count',
                    data: results.seasonal_trends.map(s => s.transaction_count),
                    backgroundColor: 'rgba(79, 70, 229, 0.6)',
                    borderColor: 'rgba(79, 70, 229, 1)'
                }]
            });
        }

        function createChart(container, title, data) {
            const canvas = $('<canvas></canvas>');
            container.append(`
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-3">${title}</h3>
                </div>
            `).find('div:last').append(canvas);

            new Chart(canvas[0].getContext('2d'), {
                type: title.includes('vs') ? 'line' : 'bar',
                data: data,
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
